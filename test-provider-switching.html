<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提供商切换功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #3d3d3d;
            border-radius: 6px;
            border: 1px solid #555;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        
        .provider-select {
            width: 200px;
            padding: 8px;
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .provider-info {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        
        .status.success {
            background: #4CAF50;
            color: white;
        }
        
        .status.error {
            background: #f44336;
            color: white;
        }
        
        .status.info {
            background: #2196F3;
            color: white;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .log-container {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry.info {
            color: #2196F3;
        }
        
        .log-entry.success {
            color: #4CAF50;
        }
        
        .log-entry.error {
            color: #f44336;
        }
        
        .log-entry.warning {
            color: #ff9800;
        }
        
        .config-display {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .highlight {
            background: #4CAF50;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>提供商切换功能测试</h1>
        <p>测试切换提供商后是否能正确从配置文件中加载对应的配置信息。</p>
        
        <div class="test-section">
            <div class="test-title">模拟配置数据</div>
            <div class="test-item">
                <h4>当前模拟的配置文件内容：</h4>
                <div class="config-display" id="mockConfigDisplay">
{
  "aiChat": {
    "provider": "openai",
    "apiKey": "sk-test-key-123",
    "baseUrl": "https://api.openai.com/v1",
    "model": "gpt-4",
    "customModel": "gpt-4-custom",
    "maxTokens": 3000,
    "temperature": 0.8
  },
  "aiCompletion": {
    "provider": "anthropic",
    "apiKey": "sk-ant-test-key-456",
    "baseUrl": "https://api.anthropic.com",
    "model": "claude-3-opus",
    "customModel": "claude-3-opus-custom",
    "autoTrigger": false,
    "triggerDelay": 800,
    "maxSuggestions": 3
  }
}
                </div>
                <button class="test-button" onclick="updateMockConfig('openai')">设置为OpenAI配置</button>
                <button class="test-button" onclick="updateMockConfig('anthropic')">设置为Anthropic配置</button>
                <button class="test-button" onclick="updateMockConfig('mixed')">设置为混合配置</button>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">AI聊天提供商切换测试</div>
            <div class="test-item">
                <label>选择提供商：</label>
                <select id="aiChatProvider" class="provider-select" onchange="testAIChatProviderSwitch()">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="local">Local</option>
                    <option value="custom">自定义</option>
                </select>
                <span id="aiChatStatus" class="status info">准备就绪</span>
                
                <div class="provider-info" id="aiChatInfo">
                    等待测试...
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">AI补全提供商切换测试</div>
            <div class="test-item">
                <label>选择提供商：</label>
                <select id="aiCompletionProvider" class="provider-select" onchange="testAICompletionProviderSwitch()">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="github">GitHub Copilot</option>
                    <option value="local">Local</option>
                    <option value="custom">自定义</option>
                </select>
                <span id="aiCompletionStatus" class="status info">准备就绪</span>
                
                <div class="provider-info" id="aiCompletionInfo">
                    等待测试...
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">批量测试</div>
            <button class="test-button" onclick="runAllTests()">运行所有测试</button>
            <button class="test-button" onclick="clearLogs()">清空日志</button>
            <button class="test-button" onclick="testCacheMechanism()">测试缓存机制</button>
            <button class="test-button" onclick="testErrorHandling()">测试错误处理</button>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry info">测试日志将显示在这里...</div>
        </div>
    </div>

    <script>
        // 模拟提供商默认配置
        const providerDefaults = {
            openai: {
                baseUrl: 'https://api.openai.com/v1',
                model: 'gpt-3.5-turbo'
            },
            anthropic: {
                baseUrl: 'https://api.anthropic.com',
                model: 'claude-3-sonnet'
            },
            local: {
                baseUrl: 'http://localhost:11434',
                model: 'llama2'
            },
            github: {
                baseUrl: 'https://api.githubcopilot.com',
                model: 'gpt-4o-copilot'
            },
            custom: {
                baseUrl: '',
                model: ''
            }
        };

        // 模拟设置对象
        let mockSettings = {
            aiChat: {
                provider: 'openai',
                apiKey: 'sk-test-key-123',
                baseUrl: 'https://api.openai.com/v1',
                model: 'gpt-4',
                customModel: 'gpt-4-custom',
                maxTokens: 3000,
                temperature: 0.8
            },
            aiCompletion: {
                provider: 'anthropic',
                apiKey: 'sk-ant-test-key-456',
                baseUrl: 'https://api.anthropic.com',
                model: 'claude-3-opus',
                customModel: 'claude-3-opus-custom',
                autoTrigger: false,
                triggerDelay: 800,
                maxSuggestions: 3
            }
        };

        // 模拟配置缓存
        let providerConfigCache = {
            aiChat: {},
            aiCompletion: {}
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text;
        }

        function updateInfo(elementId, data) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <strong>当前配置：</strong><br>
                提供商: ${data.provider}<br>
                Base URL: ${data.baseUrl}<br>
                模型: ${data.model}<br>
                自定义模型: ${data.customModel}<br>
                API Key: ${data.apiKey ? '已设置 (' + data.apiKey.substring(0, 10) + '...)' : '未设置'}<br>
                ${data.maxTokens !== undefined ? `最大令牌数: ${data.maxTokens}<br>` : ''}
                ${data.temperature !== undefined ? `温度: ${data.temperature}<br>` : ''}
                ${data.autoTrigger !== undefined ? `自动触发: ${data.autoTrigger}<br>` : ''}
                ${data.triggerDelay !== undefined ? `触发延迟: ${data.triggerDelay}ms<br>` : ''}
                ${data.maxSuggestions !== undefined ? `最大建议数: ${data.maxSuggestions}` : ''}
            `;
        }

        function updateMockConfig(type) {
            switch(type) {
                case 'openai':
                    mockSettings = {
                        aiChat: {
                            provider: 'openai',
                            apiKey: 'sk-openai-test-key',
                            baseUrl: 'https://api.openai.com/v1',
                            model: 'gpt-4-turbo',
                            customModel: 'gpt-4-turbo-custom',
                            maxTokens: 4000,
                            temperature: 0.9
                        },
                        aiCompletion: {
                            provider: 'openai',
                            apiKey: 'sk-openai-test-key',
                            baseUrl: 'https://api.openai.com/v1',
                            model: 'text-davinci-003',
                            customModel: 'text-davinci-003-custom',
                            autoTrigger: true,
                            triggerDelay: 300,
                            maxSuggestions: 8
                        }
                    };
                    break;
                case 'anthropic':
                    mockSettings = {
                        aiChat: {
                            provider: 'anthropic',
                            apiKey: 'sk-ant-test-key',
                            baseUrl: 'https://api.anthropic.com',
                            model: 'claude-3-5-sonnet',
                            customModel: 'claude-3-5-sonnet-custom',
                            maxTokens: 5000,
                            temperature: 0.7
                        },
                        aiCompletion: {
                            provider: 'anthropic',
                            apiKey: 'sk-ant-test-key',
                            baseUrl: 'https://api.anthropic.com',
                            model: 'claude-3-opus',
                            customModel: 'claude-3-opus-custom',
                            autoTrigger: false,
                            triggerDelay: 600,
                            maxSuggestions: 5
                        }
                    };
                    break;
                case 'mixed':
                    // 保持当前的混合配置
                    break;
            }
            
            // 更新显示
            document.getElementById('mockConfigDisplay').textContent = JSON.stringify(mockSettings, null, 2);
            
            // 重置缓存
            providerConfigCache = { aiChat: {}, aiCompletion: {} };
            
            log(`配置已更新为: ${type}`, 'success');
        }

        async function testAIChatProviderSwitch() {
            const provider = document.getElementById('aiChatProvider').value;
            log(`测试AI聊天提供商切换: ${provider}`, 'info');
            
            try {
                updateStatus('aiChatStatus', 'info', '切换中...');
                
                // 模拟更新逻辑
                let currentSettings = { ...mockSettings.aiChat };
                
                // 首先尝试从缓存中获取该提供商的配置
                if (providerConfigCache.aiChat[provider]) {
                    const cachedConfig = providerConfigCache.aiChat[provider];
                    currentSettings = {
                        ...currentSettings,
                        provider: provider,
                        baseUrl: cachedConfig.baseUrl,
                        model: cachedConfig.model,
                        customModel: cachedConfig.customModel || '',
                        apiKey: cachedConfig.apiKey || '',
                        maxTokens: cachedConfig.maxTokens || currentSettings.maxTokens,
                        temperature: cachedConfig.temperature || currentSettings.temperature
                    };
                    
                    log(`从缓存加载AI聊天提供商配置: ${provider}`, 'success');
                } else if (mockSettings.aiChat && mockSettings.aiChat.provider === provider) {
                    // 从配置文件中加载
                    const providerConfig = mockSettings.aiChat;
                    currentSettings = {
                        ...currentSettings,
                        provider: provider,
                        baseUrl: providerConfig.baseUrl || providerDefaults[provider]?.baseUrl || '',
                        model: providerConfig.model || providerDefaults[provider]?.model || '',
                        customModel: providerConfig.customModel || '',
                        apiKey: providerConfig.apiKey || '',
                        maxTokens: providerConfig.maxTokens || currentSettings.maxTokens,
                        temperature: providerConfig.temperature || currentSettings.temperature
                    };
                    
                    // 缓存配置以备后用
                    providerConfigCache.aiChat[provider] = {
                        baseUrl: currentSettings.baseUrl,
                        model: currentSettings.model,
                        customModel: currentSettings.customModel,
                        apiKey: currentSettings.apiKey,
                        maxTokens: currentSettings.maxTokens,
                        temperature: currentSettings.temperature
                    };
                    
                    log(`从配置文件加载AI聊天提供商配置: ${provider}`, 'success');
                } else {
                    // 使用默认配置
                    if (providerDefaults[provider]) {
                        currentSettings = {
                            ...currentSettings,
                            provider: provider,
                            baseUrl: providerDefaults[provider].baseUrl,
                            model: providerDefaults[provider].model,
                            customModel: '',
                        };
                        
                        if (provider === 'custom') {
                            currentSettings.apiKey = '';
                        }
                        
                        log(`使用默认AI聊天提供商配置: ${provider}`, 'warning');
                    } else {
                        updateStatus('aiChatStatus', 'error', '未知提供商');
                        log(`未知的AI聊天提供商: ${provider}`, 'error');
                        return;
                    }
                }
                
                updateStatus('aiChatStatus', 'success', '切换成功');
                updateInfo('aiChatInfo', currentSettings);
                
                log(`AI聊天提供商切换完成: ${provider}`, 'success');
                
            } catch (error) {
                updateStatus('aiChatStatus', 'error', '切换失败');
                log(`AI聊天提供商切换失败: ${error.message}`, 'error');
            }
        }

        async function testAICompletionProviderSwitch() {
            const provider = document.getElementById('aiCompletionProvider').value;
            log(`测试AI补全提供商切换: ${provider}`, 'info');
            
            try {
                updateStatus('aiCompletionStatus', 'info', '切换中...');
                
                // 模拟更新逻辑
                let currentSettings = { ...mockSettings.aiCompletion };
                
                // 首先尝试从缓存中获取该提供商的配置
                if (providerConfigCache.aiCompletion[provider]) {
                    const cachedConfig = providerConfigCache.aiCompletion[provider];
                    currentSettings = {
                        ...currentSettings,
                        provider: provider,
                        baseUrl: cachedConfig.baseUrl,
                        model: cachedConfig.model,
                        customModel: cachedConfig.customModel || '',
                        apiKey: cachedConfig.apiKey || '',
                        autoTrigger: cachedConfig.autoTrigger !== undefined ? cachedConfig.autoTrigger : currentSettings.autoTrigger,
                        triggerDelay: cachedConfig.triggerDelay || currentSettings.triggerDelay,
                        maxSuggestions: cachedConfig.maxSuggestions || currentSettings.maxSuggestions
                    };
                    
                    log(`从缓存加载AI补全提供商配置: ${provider}`, 'success');
                } else if (mockSettings.aiCompletion && mockSettings.aiCompletion.provider === provider) {
                    // 从配置文件中加载
                    const providerConfig = mockSettings.aiCompletion;
                    currentSettings = {
                        ...currentSettings,
                        provider: provider,
                        baseUrl: providerConfig.baseUrl || providerDefaults[provider]?.baseUrl || '',
                        model: providerConfig.model || providerDefaults[provider]?.model || '',
                        customModel: providerConfig.customModel || '',
                        apiKey: providerConfig.apiKey || '',
                        autoTrigger: providerConfig.autoTrigger !== undefined ? providerConfig.autoTrigger : currentSettings.autoTrigger,
                        triggerDelay: providerConfig.triggerDelay || currentSettings.triggerDelay,
                        maxSuggestions: providerConfig.maxSuggestions || currentSettings.maxSuggestions
                    };
                    
                    // 缓存配置以备后用
                    providerConfigCache.aiCompletion[provider] = {
                        baseUrl: currentSettings.baseUrl,
                        model: currentSettings.model,
                        customModel: currentSettings.customModel,
                        apiKey: currentSettings.apiKey,
                        autoTrigger: currentSettings.autoTrigger,
                        triggerDelay: currentSettings.triggerDelay,
                        maxSuggestions: currentSettings.maxSuggestions
                    };
                    
                    log(`从配置文件加载AI补全提供商配置: ${provider}`, 'success');
                } else {
                    // 使用默认配置
                    if (providerDefaults[provider]) {
                        currentSettings = {
                            ...currentSettings,
                            provider: provider,
                            baseUrl: providerDefaults[provider].baseUrl,
                            model: providerDefaults[provider].model,
                            customModel: '',
                        };
                        
                        if (provider === 'custom') {
                            currentSettings.apiKey = '';
                        }
                        
                        log(`使用默认AI补全提供商配置: ${provider}`, 'warning');
                    } else {
                        updateStatus('aiCompletionStatus', 'error', '未知提供商');
                        log(`未知的AI补全提供商: ${provider}`, 'error');
                        return;
                    }
                }
                
                updateStatus('aiCompletionStatus', 'success', '切换成功');
                updateInfo('aiCompletionInfo', currentSettings);
                
                log(`AI补全提供商切换完成: ${provider}`, 'success');
                
            } catch (error) {
                updateStatus('aiCompletionStatus', 'error', '切换失败');
                log(`AI补全提供商切换失败: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('开始运行所有测试...', 'info');
            
            // 测试所有AI聊天提供商
            const aiChatProviders = ['openai', 'anthropic', 'local', 'custom'];
            for (const provider of aiChatProviders) {
                document.getElementById('aiChatProvider').value = provider;
                await testAIChatProviderSwitch();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // 测试所有AI补全提供商
            const aiCompletionProviders = ['openai', 'anthropic', 'github', 'local', 'custom'];
            for (const provider of aiCompletionProviders) {
                document.getElementById('aiCompletionProvider').value = provider;
                await testAICompletionProviderSwitch();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('所有测试完成！', 'success');
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry info">日志已清空...</div>';
        }

        async function testCacheMechanism() {
            log('测试缓存机制...', 'info');
            
            // 第一次切换 - 应该从配置文件加载
            document.getElementById('aiChatProvider').value = 'openai';
            await testAIChatProviderSwitch();
            
            // 第二次切换 - 应该从缓存加载
            await new Promise(resolve => setTimeout(resolve, 100));
            await testAIChatProviderSwitch();
            
            log('缓存机制测试完成', 'success');
        }

        async function testErrorHandling() {
            log('测试错误处理...', 'info');
            
            // 模拟错误情况
            const originalDefaults = { ...providerDefaults };
            delete providerDefaults.openai;
            
            try {
                document.getElementById('aiChatProvider').value = 'openai';
                await testAIChatProviderSwitch();
            } catch (error) {
                log(`错误处理测试: ${error.message}`, 'success');
            }
            
            // 恢复默认配置
            Object.assign(providerDefaults, originalDefaults);
            
            log('错误处理测试完成', 'success');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('测试页面已加载', 'success');
            
            // 初始化显示
            updateInfo('aiChatInfo', mockSettings.aiChat);
            updateInfo('aiCompletionInfo', mockSettings.aiCompletion);
            
            // 初始化缓存
            providerConfigCache.aiChat[mockSettings.aiChat.provider] = {
                baseUrl: mockSettings.aiChat.baseUrl,
                model: mockSettings.aiChat.model,
                customModel: mockSettings.aiChat.customModel,
                apiKey: mockSettings.aiChat.apiKey,
                maxTokens: mockSettings.aiChat.maxTokens,
                temperature: mockSettings.aiChat.temperature
            };
            
            providerConfigCache.aiCompletion[mockSettings.aiCompletion.provider] = {
                baseUrl: mockSettings.aiCompletion.baseUrl,
                model: mockSettings.aiCompletion.model,
                customModel: mockSettings.aiCompletion.customModel,
                apiKey: mockSettings.aiCompletion.apiKey,
                autoTrigger: mockSettings.aiCompletion.autoTrigger,
                triggerDelay: mockSettings.aiCompletion.triggerDelay,
                maxSuggestions: mockSettings.aiCompletion.maxSuggestions
            };
            
            log('缓存初始化完成', 'success');
        });
    </script>
</body>
</html>
