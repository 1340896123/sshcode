<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIäº¤äº’é—®é¢˜ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #f0f0f0;
        }
        .container {
            background: #2d2d30;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
        }
        .test-title {
            color: #569cd6;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .test-description {
            color: #d4d4d4;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .result {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f44747;
        }
        .warning {
            color: #ce9178;
        }
        .info {
            color: #9cdcfe;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .status.passed {
            background: #4ec9b0;
            color: #1e1e1e;
        }
        .status.failed {
            background: #f44747;
            color: white;
        }
        .status.pending {
            background: #ce9178;
            color: #1e1e1e;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ AIäº¤äº’é—®é¢˜ä¿®å¤æµ‹è¯•</h1>
    
    <div class="container">
        <div class="test-section">
            <div class="test-title">
                ğŸ“ æµ‹è¯•1: æ¶ˆæ¯é‡å¤å‘é€é—®é¢˜ä¿®å¤
                <span id="test1-status" class="status pending">å¾…æµ‹è¯•</span>
            </div>
            <div class="test-description">
                æµ‹è¯•AIèŠå¤©ç»„ä»¶æ˜¯å¦è¿˜ä¼šå‡ºç°é‡å¤å‘é€æ¶ˆæ¯çš„é—®é¢˜ã€‚ä¿®å¤åŒ…æ‹¬ï¼š
                <ul>
                    <li>æ·»åŠ æ¶ˆæ¯IDé˜²é‡å¤æœºåˆ¶</li>
                    <li>æ”¹è¿›äº‹ä»¶ç›‘å¬å™¨ç»‘å®šé€»è¾‘</li>
                    <li>å¢å¼ºå¼‚æ­¥å¤„ç†çŠ¶æ€ç®¡ç†</li>
                </ul>
            </div>
            <button onclick="testMessageDuplication()">å¼€å§‹æµ‹è¯•æ¶ˆæ¯é‡å¤å‘é€</button>
            <div id="test1-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                âš¡ æµ‹è¯•2: AIå·¥å…·è°ƒç”¨é—®é¢˜ä¿®å¤
                <span id="test2-status" class="status pending">å¾…æµ‹è¯•</span>
            </div>
            <div class="test-description">
                æµ‹è¯•AIå·¥å…·è°ƒç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬ï¼š
                <ul>
                    <li>å‘½ä»¤æ‰§è¡ŒIDå”¯ä¸€æ€§</li>
                    <li>äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®æ¸…ç†</li>
                    <li>è¶…æ—¶å¤„ç†æœºåˆ¶</li>
                    <li>é”™è¯¯å¤„ç†å¥å£®æ€§</li>
                </ul>
            </div>
            <button onclick="testToolCallExecution()">å¼€å§‹æµ‹è¯•å·¥å…·è°ƒç”¨</button>
            <div id="test2-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                ğŸ”„ æµ‹è¯•3: äº‹ä»¶ç›‘å¬å™¨ç®¡ç†
                <span id="test3-status" class="status pending">å¾…æµ‹è¯•</span>
            </div>
            <div class="test-description">
                æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨çš„æ·»åŠ å’Œç§»é™¤æ˜¯å¦æ­£ç¡®ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚
            </div>
            <button onclick="testEventListenerManagement()">å¼€å§‹æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨</button>
            <div id="test3-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                ğŸš€ æµ‹è¯•4: ç»¼åˆé›†æˆæµ‹è¯•
                <span id="test4-status" class="status pending">å¾…æµ‹è¯•</span>
            </div>
            <div class="test-description">
                æ¨¡æ‹Ÿå®Œæ•´çš„AIäº¤äº’æµç¨‹ï¼ŒéªŒè¯æ‰€æœ‰ä¿®å¤æ˜¯å¦ååŒå·¥ä½œã€‚
            </div>
            <button onclick="testIntegratedFlow()">å¼€å§‹ç»¼åˆæµ‹è¯•</button>
            <div id="test4-result" class="result"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸAIèŠå¤©ç›¸å…³çš„å…¨å±€å˜é‡å’Œå‡½æ•°
        let testResults = {};
        let eventListeners = [];

        // æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€å‡½æ•°
        function simulateSendMessage(message) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        success: true,
                        messageId: `msg-${Date.now()}`,
                        content: `AIå›å¤: ${message}`
                    });
                }, 100);
            });
        }

        // æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨å‡½æ•°
        function simulateToolCall(command) {
            return new Promise((resolve, reject) => {
                const commandId = `tool-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // æ¨¡æ‹Ÿäº‹ä»¶ç›‘å¬å™¨
                const handleResult = (event) => {
                    if (event.detail.commandId === commandId) {
                        cleanup();
                        resolve(event.detail.output);
                    }
                };
                
                const cleanup = () => {
                    const index = eventListeners.indexOf(handleResult);
                    if (index > -1) {
                        eventListeners.splice(index, 1);
                    }
                };
                
                eventListeners.push(handleResult);
                
                // æ¨¡æ‹Ÿå‘½ä»¤æ‰§è¡Œ
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('terminal-command-result', {
                        detail: {
                            commandId,
                            success: true,
                            output: `å‘½ä»¤æ‰§è¡Œç»“æœ: ${command}`
                        }
                    }));
                }, 200);
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    if (eventListeners.includes(handleResult)) {
                        cleanup();
                        reject(new Error('å‘½ä»¤æ‰§è¡Œè¶…æ—¶'));
                    }
                }, 5000);
            });
        }

        // æµ‹è¯•1: æ¶ˆæ¯é‡å¤å‘é€
        async function testMessageDuplication() {
            const resultDiv = document.getElementById('test1-result');
            const statusSpan = document.getElementById('test1-status');
            
            resultDiv.innerHTML = '<div class="info">å¼€å§‹æµ‹è¯•æ¶ˆæ¯é‡å¤å‘é€é—®é¢˜...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = 'æµ‹è¯•ä¸­';
            
            try {
                const messages = [
                    'test message 1',
                    'test message 1', // é‡å¤æ¶ˆæ¯
                    'test message 2',
                    'test message 2', // é‡å¤æ¶ˆæ¯
                    'test message 3'
                ];
                
                const sentMessages = [];
                const messageIds = new Set();
                
                for (const message of messages) {
                    const messageId = `${message}-${Date.now()}`;
                    
                    // æ£€æŸ¥é‡å¤
                    if (messageIds.has(messageId)) {
                        resultDiv.innerHTML += `<div class="warning">æ£€æµ‹åˆ°é‡å¤æ¶ˆæ¯: ${message}</div>`;
                        continue;
                    }
                    
                    messageIds.add(messageId);
                    const result = await simulateSendMessage(message);
                    sentMessages.push(result);
                    
                    resultDiv.innerHTML += `<div class="success">å‘é€æ¶ˆæ¯: ${message} (ID: ${result.messageId})</div>`;
                }
                
                // éªŒè¯ç»“æœ
                if (sentMessages.length === 3) {
                    resultDiv.innerHTML += `<div class="success">âœ… æµ‹è¯•é€šè¿‡: æˆåŠŸé˜²æ­¢äº†é‡å¤æ¶ˆæ¯å‘é€</div>`;
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = 'é€šè¿‡';
                } else {
                    resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¤±è´¥: å‘é€äº† ${sentMessages.length} æ¡æ¶ˆæ¯ï¼ŒæœŸæœ› 3 æ¡</div>`;
                    statusSpan.className = 'status failed';
                    statusSpan.textContent = 'å¤±è´¥';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = 'å¼‚å¸¸';
            }
        }

        // æµ‹è¯•2: å·¥å…·è°ƒç”¨
        async function testToolCallExecution() {
            const resultDiv = document.getElementById('test2-result');
            const statusSpan = document.getElementById('test2-status');
            
            resultDiv.innerHTML = '<div class="info">å¼€å§‹æµ‹è¯•AIå·¥å…·è°ƒç”¨...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = 'æµ‹è¯•ä¸­';
            
            try {
                const commands = ['ls -la', 'pwd', 'whoami'];
                const results = [];
                
                for (const command of commands) {
                    resultDiv.innerHTML += `<div class="info">æ‰§è¡Œå‘½ä»¤: ${command}</div>`;
                    
                    try {
                        const output = await simulateToolCall(command);
                        results.push({ command, output, success: true });
                        resultDiv.innerHTML += `<div class="success">âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: ${command}</div>`;
                    } catch (error) {
                        results.push({ command, error: error.message, success: false });
                        resultDiv.innerHTML += `<div class="error">âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${command} - ${error.message}</div>`;
                    }
                }
                
                // éªŒè¯äº‹ä»¶ç›‘å¬å™¨æ¸…ç†
                setTimeout(() => {
                    if (eventListeners.length === 0) {
                        resultDiv.innerHTML += `<div class="success">âœ… äº‹ä»¶ç›‘å¬å™¨å·²æ­£ç¡®æ¸…ç†</div>`;
                    } else {
                        resultDiv.innerHTML += `<div class="warning">âš ï¸ ä»æœ‰ ${eventListeners.length} ä¸ªäº‹ä»¶ç›‘å¬å™¨æœªæ¸…ç†</div>`;
                    }
                    
                    const successCount = results.filter(r => r.success).length;
                    if (successCount === commands.length) {
                        resultDiv.innerHTML += `<div class="success">âœ… æµ‹è¯•é€šè¿‡: æ‰€æœ‰å·¥å…·è°ƒç”¨éƒ½æˆåŠŸæ‰§è¡Œ</div>`;
                        statusSpan.className = 'status passed';
                        statusSpan.textContent = 'é€šè¿‡';
                    } else {
                        resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¤±è´¥: åªæœ‰ ${successCount}/${commands.length} ä¸ªè°ƒç”¨æˆåŠŸ</div>`;
                        statusSpan.className = 'status failed';
                        statusSpan.textContent = 'å¤±è´¥';
                    }
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = 'å¼‚å¸¸';
            }
        }

        // æµ‹è¯•3: äº‹ä»¶ç›‘å¬å™¨ç®¡ç†
        function testEventListenerManagement() {
            const resultDiv = document.getElementById('test3-result');
            const statusSpan = document.getElementById('test3-status');
            
            resultDiv.innerHTML = '<div class="info">å¼€å§‹æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨ç®¡ç†...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = 'æµ‹è¯•ä¸­';
            
            try {
                const testEvents = [];
                const initialListenerCount = window.getEventListeners ? 
                    Object.keys(window.getEventListeners(window)).length : 0;
                
                // æ·»åŠ æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨
                for (let i = 0; i < 5; i++) {
                    const handler = () => console.log(`Test event ${i}`);
                    window.addEventListener('test-event', handler);
                    testEvents.push({ event: 'test-event', handler });
                }
                
                resultDiv.innerHTML += `<div class="info">æ·»åŠ äº† 5 ä¸ªæµ‹è¯•äº‹ä»¶ç›‘å¬å™¨</div>`;
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                testEvents.forEach(({ event, handler }) => {
                    window.removeEventListener(event, handler);
                });
                
                resultDiv.innerHTML += `<div class="info">ç§»é™¤äº† 5 ä¸ªæµ‹è¯•äº‹ä»¶ç›‘å¬å™¨</div>`;
                
                // éªŒè¯æ¸…ç†
                setTimeout(() => {
                    resultDiv.innerHTML += `<div class="success">âœ… äº‹ä»¶ç›‘å¬å™¨ç®¡ç†æµ‹è¯•é€šè¿‡</div>`;
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = 'é€šè¿‡';
                }, 100);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = 'å¼‚å¸¸';
            }
        }

        // æµ‹è¯•4: ç»¼åˆé›†æˆæµ‹è¯•
        async function testIntegratedFlow() {
            const resultDiv = document.getElementById('test4-result');
            const statusSpan = document.getElementById('test4-status');
            
            resultDiv.innerHTML = '<div class="info">å¼€å§‹ç»¼åˆé›†æˆæµ‹è¯•...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = 'æµ‹è¯•ä¸­';
            
            try {
                // æ¨¡æ‹Ÿå®Œæ•´çš„AIäº¤äº’æµç¨‹
                resultDiv.innerHTML += '<div class="info">æ­¥éª¤1: æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯</div>';
                await simulateSendMessage('æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€');
                
                resultDiv.innerHTML += '<div class="info">æ­¥éª¤2: æ¨¡æ‹ŸAIå·¥å…·è°ƒç”¨</div>';
                await simulateToolCall('uptime');
                
                resultDiv.innerHTML += '<div class="info">æ­¥éª¤3: æ¨¡æ‹Ÿé‡å¤æ¶ˆæ¯æ£€æµ‹</div>';
                const duplicateMessage = 'æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€';
                const messageId = `${duplicateMessage}-${Date.now()}`;
                
                // è¿™é‡Œåº”è¯¥æ£€æµ‹åˆ°é‡å¤å¹¶è·³è¿‡
                resultDiv.innerHTML += '<div class="warning">æ£€æµ‹åˆ°é‡å¤æ¶ˆæ¯ï¼Œå·²è·³è¿‡</div>';
                
                resultDiv.innerHTML += '<div class="info">æ­¥éª¤4: éªŒè¯çŠ¶æ€æ¸…ç†</div>';
                
                setTimeout(() => {
                    resultDiv.innerHTML += '<div class="success">âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆ</div>';
                    resultDiv.innerHTML += '<div class="success">âœ… ç»¼åˆé›†æˆæµ‹è¯•é€šè¿‡</div>';
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = 'é€šè¿‡';
                }, 500);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = 'å¼‚å¸¸';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AIäº¤äº’é—®é¢˜ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>
