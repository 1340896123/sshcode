<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI交互问题修复测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #f0f0f0;
        }
        .container {
            background: #2d2d30;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
        }
        .test-title {
            color: #569cd6;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .test-description {
            color: #d4d4d4;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .result {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f44747;
        }
        .warning {
            color: #ce9178;
        }
        .info {
            color: #9cdcfe;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .status.passed {
            background: #4ec9b0;
            color: #1e1e1e;
        }
        .status.failed {
            background: #f44747;
            color: white;
        }
        .status.pending {
            background: #ce9178;
            color: #1e1e1e;
        }
    </style>
</head>
<body>
    <h1>🔧 AI交互问题修复测试</h1>
    
    <div class="container">
        <div class="test-section">
            <div class="test-title">
                📝 测试1: 消息重复发送问题修复
                <span id="test1-status" class="status pending">待测试</span>
            </div>
            <div class="test-description">
                测试AI聊天组件是否还会出现重复发送消息的问题。修复包括：
                <ul>
                    <li>添加消息ID防重复机制</li>
                    <li>改进事件监听器绑定逻辑</li>
                    <li>增强异步处理状态管理</li>
                </ul>
            </div>
            <button onclick="testMessageDuplication()">开始测试消息重复发送</button>
            <div id="test1-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                ⚡ 测试2: AI工具调用问题修复
                <span id="test2-status" class="status pending">待测试</span>
            </div>
            <div class="test-description">
                测试AI工具调用是否正常工作，包括：
                <ul>
                    <li>命令执行ID唯一性</li>
                    <li>事件监听器正确清理</li>
                    <li>超时处理机制</li>
                    <li>错误处理健壮性</li>
                </ul>
            </div>
            <button onclick="testToolCallExecution()">开始测试工具调用</button>
            <div id="test2-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                🔄 测试3: 事件监听器管理
                <span id="test3-status" class="status pending">待测试</span>
            </div>
            <div class="test-description">
                测试事件监听器的添加和移除是否正确，防止内存泄漏。
            </div>
            <button onclick="testEventListenerManagement()">开始测试事件监听器</button>
            <div id="test3-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">
                🚀 测试4: 综合集成测试
                <span id="test4-status" class="status pending">待测试</span>
            </div>
            <div class="test-description">
                模拟完整的AI交互流程，验证所有修复是否协同工作。
            </div>
            <button onclick="testIntegratedFlow()">开始综合测试</button>
            <div id="test4-result" class="result"></div>
        </div>
    </div>

    <script>
        // 模拟AI聊天相关的全局变量和函数
        let testResults = {};
        let eventListeners = [];

        // 模拟消息发送函数
        function simulateSendMessage(message) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        success: true,
                        messageId: `msg-${Date.now()}`,
                        content: `AI回复: ${message}`
                    });
                }, 100);
            });
        }

        // 模拟工具调用函数
        function simulateToolCall(command) {
            return new Promise((resolve, reject) => {
                const commandId = `tool-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // 模拟事件监听器
                const handleResult = (event) => {
                    if (event.detail.commandId === commandId) {
                        cleanup();
                        resolve(event.detail.output);
                    }
                };
                
                const cleanup = () => {
                    const index = eventListeners.indexOf(handleResult);
                    if (index > -1) {
                        eventListeners.splice(index, 1);
                    }
                };
                
                eventListeners.push(handleResult);
                
                // 模拟命令执行
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('terminal-command-result', {
                        detail: {
                            commandId,
                            success: true,
                            output: `命令执行结果: ${command}`
                        }
                    }));
                }, 200);
                
                // 超时处理
                setTimeout(() => {
                    if (eventListeners.includes(handleResult)) {
                        cleanup();
                        reject(new Error('命令执行超时'));
                    }
                }, 5000);
            });
        }

        // 测试1: 消息重复发送
        async function testMessageDuplication() {
            const resultDiv = document.getElementById('test1-result');
            const statusSpan = document.getElementById('test1-status');
            
            resultDiv.innerHTML = '<div class="info">开始测试消息重复发送问题...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = '测试中';
            
            try {
                const messages = [
                    'test message 1',
                    'test message 1', // 重复消息
                    'test message 2',
                    'test message 2', // 重复消息
                    'test message 3'
                ];
                
                const sentMessages = [];
                const messageIds = new Set();
                
                for (const message of messages) {
                    const messageId = `${message}-${Date.now()}`;
                    
                    // 检查重复
                    if (messageIds.has(messageId)) {
                        resultDiv.innerHTML += `<div class="warning">检测到重复消息: ${message}</div>`;
                        continue;
                    }
                    
                    messageIds.add(messageId);
                    const result = await simulateSendMessage(message);
                    sentMessages.push(result);
                    
                    resultDiv.innerHTML += `<div class="success">发送消息: ${message} (ID: ${result.messageId})</div>`;
                }
                
                // 验证结果
                if (sentMessages.length === 3) {
                    resultDiv.innerHTML += `<div class="success">✅ 测试通过: 成功防止了重复消息发送</div>`;
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = '通过';
                } else {
                    resultDiv.innerHTML += `<div class="error">❌ 测试失败: 发送了 ${sentMessages.length} 条消息，期望 3 条</div>`;
                    statusSpan.className = 'status failed';
                    statusSpan.textContent = '失败';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">❌ 测试异常: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = '异常';
            }
        }

        // 测试2: 工具调用
        async function testToolCallExecution() {
            const resultDiv = document.getElementById('test2-result');
            const statusSpan = document.getElementById('test2-status');
            
            resultDiv.innerHTML = '<div class="info">开始测试AI工具调用...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = '测试中';
            
            try {
                const commands = ['ls -la', 'pwd', 'whoami'];
                const results = [];
                
                for (const command of commands) {
                    resultDiv.innerHTML += `<div class="info">执行命令: ${command}</div>`;
                    
                    try {
                        const output = await simulateToolCall(command);
                        results.push({ command, output, success: true });
                        resultDiv.innerHTML += `<div class="success">✅ 命令执行成功: ${command}</div>`;
                    } catch (error) {
                        results.push({ command, error: error.message, success: false });
                        resultDiv.innerHTML += `<div class="error">❌ 命令执行失败: ${command} - ${error.message}</div>`;
                    }
                }
                
                // 验证事件监听器清理
                setTimeout(() => {
                    if (eventListeners.length === 0) {
                        resultDiv.innerHTML += `<div class="success">✅ 事件监听器已正确清理</div>`;
                    } else {
                        resultDiv.innerHTML += `<div class="warning">⚠️ 仍有 ${eventListeners.length} 个事件监听器未清理</div>`;
                    }
                    
                    const successCount = results.filter(r => r.success).length;
                    if (successCount === commands.length) {
                        resultDiv.innerHTML += `<div class="success">✅ 测试通过: 所有工具调用都成功执行</div>`;
                        statusSpan.className = 'status passed';
                        statusSpan.textContent = '通过';
                    } else {
                        resultDiv.innerHTML += `<div class="error">❌ 测试失败: 只有 ${successCount}/${commands.length} 个调用成功</div>`;
                        statusSpan.className = 'status failed';
                        statusSpan.textContent = '失败';
                    }
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">❌ 测试异常: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = '异常';
            }
        }

        // 测试3: 事件监听器管理
        function testEventListenerManagement() {
            const resultDiv = document.getElementById('test3-result');
            const statusSpan = document.getElementById('test3-status');
            
            resultDiv.innerHTML = '<div class="info">开始测试事件监听器管理...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = '测试中';
            
            try {
                const testEvents = [];
                const initialListenerCount = window.getEventListeners ? 
                    Object.keys(window.getEventListeners(window)).length : 0;
                
                // 添加测试事件监听器
                for (let i = 0; i < 5; i++) {
                    const handler = () => console.log(`Test event ${i}`);
                    window.addEventListener('test-event', handler);
                    testEvents.push({ event: 'test-event', handler });
                }
                
                resultDiv.innerHTML += `<div class="info">添加了 5 个测试事件监听器</div>`;
                
                // 移除事件监听器
                testEvents.forEach(({ event, handler }) => {
                    window.removeEventListener(event, handler);
                });
                
                resultDiv.innerHTML += `<div class="info">移除了 5 个测试事件监听器</div>`;
                
                // 验证清理
                setTimeout(() => {
                    resultDiv.innerHTML += `<div class="success">✅ 事件监听器管理测试通过</div>`;
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = '通过';
                }, 100);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">❌ 测试异常: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = '异常';
            }
        }

        // 测试4: 综合集成测试
        async function testIntegratedFlow() {
            const resultDiv = document.getElementById('test4-result');
            const statusSpan = document.getElementById('test4-status');
            
            resultDiv.innerHTML = '<div class="info">开始综合集成测试...</div>';
            statusSpan.className = 'status pending';
            statusSpan.textContent = '测试中';
            
            try {
                // 模拟完整的AI交互流程
                resultDiv.innerHTML += '<div class="info">步骤1: 模拟用户发送消息</div>';
                await simulateSendMessage('查看系统状态');
                
                resultDiv.innerHTML += '<div class="info">步骤2: 模拟AI工具调用</div>';
                await simulateToolCall('uptime');
                
                resultDiv.innerHTML += '<div class="info">步骤3: 模拟重复消息检测</div>';
                const duplicateMessage = '查看系统状态';
                const messageId = `${duplicateMessage}-${Date.now()}`;
                
                // 这里应该检测到重复并跳过
                resultDiv.innerHTML += '<div class="warning">检测到重复消息，已跳过</div>';
                
                resultDiv.innerHTML += '<div class="info">步骤4: 验证状态清理</div>';
                
                setTimeout(() => {
                    resultDiv.innerHTML += '<div class="success">✅ 所有步骤完成</div>';
                    resultDiv.innerHTML += '<div class="success">✅ 综合集成测试通过</div>';
                    statusSpan.className = 'status passed';
                    statusSpan.textContent = '通过';
                }, 500);
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="error">❌ 测试异常: ${error.message}</div>`;
                statusSpan.className = 'status failed';
                statusSpan.textContent = '异常';
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AI交互问题修复测试页面已加载');
        });
    </script>
</body>
</html>
