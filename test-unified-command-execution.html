<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统一命令执行组件测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 20px;
        }

        .demo-section {
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .demo-section-header {
            background: #f7fafc;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .demo-section-content {
            padding: 15px;
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 12px;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-idle { background: #cbd5e0; }
        .status-executing { background: #f6ad55; }
        .status-completed { background: #68d391; }
        .status-failed { background: #fc8181; }

        .mock-command-execution {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
            background: #2a2a2a;
        }

        .mock-execution-header {
            background: #333;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #3a3a3a;
        }

        .mock-execution-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mock-execution-content {
            padding: 12px;
            border-top: 1px solid #3a3a3a;
            max-height: 300px;
            overflow-y: auto;
        }

        .mock-output {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #e0e0e0;
            margin: 8px 0;
        }

        .collapsible {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible.expanded {
            max-height: 500px;
            opacity: 1;
        }

        .progress-bar {
            height: 4px;
            background: #4a5568;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: #3b82f6;
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #cbd5e0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 11px;
            color: #888;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #888;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }

        .input-group textarea {
            min-height: 60px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 统一命令执行组件测试</h1>
            <p>测试 AI 工具调用与命令完成的统一组件</p>
        </div>

        <div class="content">
            <!-- 模拟用户输入 -->
            <div class="demo-section">
                <div class="demo-section-header">
                    <h3>👤 用户消息模拟</h3>
                    <span class="status-indicator status-idle"></span>
                </div>
                <div class="demo-section-content">
                    <div class="input-group">
                        <label>用户消息内容:</label>
                        <textarea id="userMessage" placeholder="输入用户消息...">帮我查看当前目录的文件列表</textarea>
                    </div>
                    <button class="button" onclick="addUserMessage()">添加用户消息</button>
                </div>
            </div>

            <!-- 模拟AI回复 -->
            <div class="demo-section">
                <div class="demo-section-header">
                    <h3>🤖 AI回复模拟</h3>
                    <span class="status-indicator status-idle"></span>
                </div>
                <div class="demo-section-content">
                    <div class="input-group">
                        <label>AI回复内容:</label>
                        <textarea id="aiMessage" placeholder="输入AI回复..."">我来帮您查看当前目录的文件。我将使用 `ls -la` 命令来获取详细的文件列表。</textarea>
                    </div>
                    <button class="button" onclick="addAIMessage()">添加AI回复</button>
                </div>
            </div>

            <!-- 模拟工具调用 -->
            <div class="demo-section">
                <div class="demo-section-header">
                    <h3>🔧 工具调用模拟</h3>
                    <span class="status-indicator status-idle"></span>
                </div>
                <div class="demo-section-content">
                    <div class="input-group">
                        <label>命令:</label>
                        <input type="text" id="toolCommand" value="ls -la" placeholder="输入要执行的命令...">
                    </div>
                    <div class="controls">
                        <button class="button" onclick="simulateToolStart()">开始执行</button>
                        <button class="button" onclick="simulateToolComplete()">执行完成</button>
                        <button class="button" onclick="simulateToolError()">执行失败</button>
                        <button class="button" onclick="clearDemo()">清空演示</button>
                    </div>
                    <div class="stats">
                        <span>总消息: <strong id="totalMessages">0</strong></span>
                        <span>执行中: <strong id="executingCount">0</strong></span>
                        <span>已完成: <strong id="completedCount">0</strong></span>
                        <span>失败: <strong id="failedCount">0</strong></span>
                    </div>
                </div>
            </div>

            <!-- 消息显示区域 -->
            <div class="demo-section">
                <div class="demo-section-header">
                    <h3>📝 消息流</h3>
                    <button class="button" onclick="clearMessages()">清空消息</button>
                </div>
                <div class="demo-section-content">
                    <div id="messageContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 消息管理
        let messages = [];
        let messageIdCounter = 1;
        let executingCommands = new Map();

        // 统计计数器
        const stats = {
            total: 0,
            executing: 0,
            completed: 0,
            failed: 0
        };

        function updateStats() {
            document.getElementById('totalMessages').textContent = stats.total;
            document.getElementById('executingCount').textContent = stats.executing;
            document.getElementById('completedCount').textContent = stats.completed;
            document.getElementById('failedCount').textContent = stats.failed;
        }

        function createMessage(role, content, metadata = null, type = null) {
            const message = {
                id: messageIdCounter++,
                role,
                content,
                metadata,
                type,
                timestamp: new Date()
            };
            messages.push(message);
            stats.total++;
            updateStats();
            return message;
        }

        function addUserMessage() {
            const content = document.getElementById('userMessage').value.trim();
            if (!content) return;

            const message = createMessage('user', content);
            renderMessage(message);
            document.getElementById('userMessage').value = '';
        }

        function addAIMessage() {
            const content = document.getElementById('aiMessage').value.trim();
            if (!content) return;

            const message = createMessage('assistant', content);
            renderMessage(message);
            document.getElementById('aiMessage').value = '';
        }

        function simulateToolStart() {
            const command = document.getElementById('toolCommand').value.trim();
            if (!command) return;

            const toolCallId = `tool-${Date.now()}`;
            const message = createMessage('system', `🤖 AI想要执行命令: \`${command}\``, {
                command,
                toolCallId,
                status: 'executing'
            }, 'tool-start');

            executingCommands.set(toolCallId, message);
            stats.executing++;
            updateStats();
            renderMessage(message);
        }

        function simulateToolComplete() {
            const command = document.getElementById('toolCommand').value.trim();
            if (!command) return;

            // 模拟命令输出
            const mockOutput = `total 24
drwxr-xr-x  5 user user  4096 Jan 10 10:30 .
drwxr-xr-x  3 root root  4096 Jan  5 09:15 ..
-rw-r--r--  1 user user  1234 Jan  8 14:20 config.json
-rw-r--r--  1 user user  5678 Jan  9 11:45 data.csv
drwxr-xr-x  2 user user  4096 Jan 10 09:00 logs
-rw-r--r--  1 user user  2345 Jan 10 10:30 report.pdf
drwxr-xr-x  3 user user  4096 Jan  7 16:20 src
-rw-r--r--  1 user user  890 Jan  6 13:10 README.md`;

            const toolCallId = `tool-${Date.now()}`;
            const message = createMessage('system', `✅ 命令执行完成: \`${command}\``, {
                command,
                toolCallId,
                status: 'completed',
                result: mockOutput,
                executionTime: 2500
            }, 'tool-result');

            // 更新统计
            stats.executing--;
            stats.completed++;
            updateStats();
            renderMessage(message);
        }

        function simulateToolError() {
            const command = document.getElementById('toolCommand').value.trim();
            if (!command) return;

            const toolCallId = `tool-${Date.now()}`;
            const message = createMessage('system', `❌ 命令执行失败: \`${command}\``, {
                command,
                toolCallId,
                status: 'error',
                error: 'bash: command not found'
            }, 'tool-result');

            // 更新统计
            stats.executing--;
            stats.failed++;
            updateStats();
            renderMessage(message);
        }

        function renderMessage(message) {
            const container = document.getElementById('messageContainer');
            const messageElement = createMessageElement(message);
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function createMessageElement(message) {
            const div = document.createElement('div');
            div.className = 'mock-command-execution';
            div.id = `message-${message.id}`;

            let statusClass = 'status-idle';
            let statusText = '消息';
            let iconHtml = '<span class="icon info">ℹ️</span>';

            if (message.role === 'user') {
                statusClass = 'status-idle';
                statusText = '用户输入';
                iconHtml = '<span class="icon">👤</span>';
            } else if (message.role === 'assistant') {
                statusClass = 'status-idle';
                statusText = 'AI回复';
                iconHtml = '<span class="icon">🤖</span>';
            } else if (message.type === 'tool-start') {
                statusClass = 'status-executing';
                statusText = '执行中';
                iconHtml = '<span class="spinner"></span>';
            } else if (message.type === 'tool-result') {
                if (message.metadata?.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = '已完成';
                    iconHtml = '<span class="icon success">✅</span>';
                } else if (message.metadata?.status === 'error') {
                    statusClass = 'status-failed';
                    statusText = '失败';
                    iconHtml = '<span class="icon error">❌</span>';
                }
            }

            let headerHtml = `
                <div class="mock-execution-header" onclick="toggleCollapse(${message.id})">
                    <div class="mock-execution-info">
                        <span class="status-indicator ${statusClass}"></span>
                        ${iconHtml}
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">
                                ${statusText}
                                ${message.metadata?.command ? `<code style="margin-left: 8px; background: rgba(245, 158, 11, 0.2); padding: 2px 6px; border-radius: 3px; font-size: 11px;">${message.metadata.command}</code>` : ''}
                            </div>
                            <div style="font-size: 11px; color: #888;">
                                ${message.timestamp.toLocaleTimeString()}
                                ${message.metadata?.executionTime ? ` • ⏱ ${(message.metadata.executionTime / 1000).toFixed(2)}s` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 20px; cursor: pointer; user-select: none;">
                        ${message.type === 'tool-start' || message.type === 'tool-result' ? '▼' : ''}
                    </div>
                </div>
            `;

            let contentHtml = '';
            if (message.type === 'tool-start') {
                contentHtml = `
                    <div class="mock-execution-content collapsible expanded" id="content-${message.id}">
                        <div style="text-align: center; padding: 20px;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <p style="margin-top: 10px; font-size: 12px; color: #888;">AI工具调用正在进行中，请稍候...</p>
                        </div>
                    </div>
                `;
            } else if (message.type === 'tool-result' && message.metadata?.status === 'completed') {
                contentHtml = `
                    <div class="mock-execution-content collapsible expanded" id="content-${message.id}">
                        <div style="margin-bottom: 10px; font-size: 12px; color: #4ade80;">
                            ✅ 命令执行成功
                        </div>
                        <div class="mock-output">${message.metadata.result}</div>
                        <div style="margin-top: 10px; font-size: 11px; color: #888;">
                            输出长度: ${message.metadata.result.length} 字符
                        </div>
                    </div>
                `;
            } else if (message.type === 'tool-result' && message.metadata?.status === 'error') {
                contentHtml = `
                    <div class="mock-execution-content collapsible expanded" id="content-${message.id}">
                        <div style="margin-bottom: 10px; font-size: 12px; color: #ef4444;">
                            ❌ 命令执行失败
                        </div>
                        <div class="mock-output" style="color: #ef4444;">${message.metadata.error}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #3b82f6;">
                            💡 建议: 请检查命令拼写是否正确，或确保命令已安装
                        </div>
                    </div>
                `;
            } else if (message.content) {
                contentHtml = `
                    <div class="mock-execution-content" style="padding: 12px; font-size: 13px; line-height: 1.5;">
                        ${message.content}
                    </div>
                `;
            }

            div.innerHTML = headerHtml + contentHtml;
            return div;
        }

        function toggleCollapse(messageId) {
            const content = document.getElementById(`content-${messageId}`);
            if (content) {
                content.classList.toggle('expanded');
            }
        }

        function clearDemo() {
            document.getElementById('toolCommand').value = '';
            executingCommands.clear();
            stats.executing = 0;
            updateStats();
        }

        function clearMessages() {
            messages = [];
            messageIdCounter = 1;
            executingCommands.clear();
            stats.total = 0;
            stats.executing = 0;
            stats.completed = 0;
            stats.failed = 0;
            updateStats();
            document.getElementById('messageContainer').innerHTML = '';
        }

        // 初始化
        updateStats();
        console.log('🚀 统一命令执行组件测试页面已加载');
    </script>
</body>
</html>