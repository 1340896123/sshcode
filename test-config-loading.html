<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置加载测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .config-item {
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .config-item strong {
            color: #666;
            display: inline-block;
            width: 150px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>配置加载测试</h1>
        
        <div class="section">
            <h3>测试控制</h3>
            <button onclick="testLoadConfig()">测试加载配置</button>
            <button onclick="testSaveConfig()">测试保存配置</button>
            <button onclick="clearDisplay()">清空显示</button>
        </div>

        <div class="section">
            <h3>加载的配置</h3>
            <div id="loadedConfig">
                <p>点击"测试加载配置"按钮来加载配置</p>
            </div>
        </div>

        <div class="section">
            <h3>原始配置数据</h3>
            <pre id="rawConfig">暂无数据</pre>
        </div>

        <div class="section">
            <h3>处理后的配置数据</h3>
            <pre id="processedConfig">暂无数据</pre>
        </div>

        <div class="section">
            <h3>消息日志</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        // 模拟 electronAPI
        window.electronAPI = {
            getConfig: async () => {
                try {
                    // 读取 config/app.yml 文件
                    const response = await fetch('./config/app.yml');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const yamlText = await response.text();
                    
                    // 简单的 YAML 解析（这里只是模拟，实际应该使用 js-yaml 库）
                    const config = parseSimpleYAML(yamlText);
                    
                    logMessage('配置文件读取成功', 'success');
                    return config;
                } catch (error) {
                    logMessage(`读取配置失败: ${error.message}`, 'error');
                    return null;
                }
            },
            
            saveConfig: async (config) => {
                try {
                    logMessage(`保存配置: ${JSON.stringify(config, null, 2)}`, 'success');
                    return { success: true };
                } catch (error) {
                    logMessage(`保存配置失败: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }
        };

        // 简单的 YAML 解析器（仅用于测试）
        function parseSimpleYAML(yamlText) {
            const lines = yamlText.split('\n');
            const result = {};
            let currentSection = result;
            const sectionStack = [result];
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) return;
                
                const indent = line.search(/\S/);
                const level = Math.floor(indent / 2);
                
                while (sectionStack.length > level + 1) {
                    sectionStack.pop();
                }
                
                currentSection = sectionStack[sectionStack.length - 1];
                
                if (trimmed.includes(':')) {
                    const [key, ...valueParts] = trimmed.split(':');
                    const value = valueParts.join(':').trim();
                    
                    if (value === '') {
                        // 这是一个新的节
                        const newSection = {};
                        currentSection[key.trim()] = newSection;
                        sectionStack.push(newSection);
                        currentSection = newSection;
                    } else {
                        // 这是一个键值对
                        let parsedValue = value;
                        if (value.startsWith('"') && value.endsWith('"')) {
                            parsedValue = value.slice(1, -1);
                        } else if (!isNaN(value)) {
                            parsedValue = Number(value);
                        } else if (value === 'true' || value === 'false') {
                            parsedValue = value === 'true';
                        }
                        currentSection[key.trim()] = parsedValue;
                    }
                }
            });
            
            return result;
        }

        function logMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function displayConfig(config, containerId) {
            const container = document.getElementById(containerId);
            if (!config) {
                container.innerHTML = '<p>无配置数据</p>';
                return;
            }

            let html = '';
            function buildHtml(obj, prefix = '') {
                for (const [key, value] of Object.entries(obj)) {
                    if (typeof value === 'object' && value !== null) {
                        html += `<div class="config-item"><strong>${prefix}${key}:</strong></div>`;
                        buildHtml(value, prefix + key + '.');
                    } else {
                        html += `<div class="config-item"><strong>${prefix}${key}:</strong> ${value}</div>`;
                    }
                }
            }
            
            buildHtml(config);
            container.innerHTML = html;
        }

        async function testLoadConfig() {
            logMessage('开始测试配置加载...');
            
            try {
                const savedSettings = await window.electronAPI.getConfig();
                
                // 显示原始配置
                document.getElementById('rawConfig').textContent = JSON.stringify(savedSettings, null, 2);
                
                if (savedSettings) {
                    // 模拟 SettingsModal.vue 中的配置处理逻辑
                    const defaultSettings = {
                        aiChat: {
                            provider: 'openai',
                            apiKey: '',
                            baseUrl: 'https://api.openai.com/v1',
                            model: 'gpt-3.5-turbo',
                            customModel: '',
                            maxTokens: 2000,
                            temperature: 0.7,
                            systemPromptEnabled: false,
                            systemPrompt: '你是一个专业的编程助手，请帮助用户解决编程问题。',
                            saveHistory: true,
                            historyRetentionDays: 30
                        },
                        aiCompletion: {
                            provider: 'openai',
                            apiKey: '',
                            baseUrl: 'https://api.openai.com/v1',
                            model: 'gpt-3.5-turbo',
                            customModel: '',
                            autoTrigger: true,
                            triggerDelay: 500,
                            maxSuggestions: 5,
                            acceptOnTab: true
                        },
                        terminal: {
                            font: 'Consolas',
                            fontSize: 14,
                            lineHeight: 1.2,
                            bell: false,
                            cursorBlink: true,
                            cursorStyle: 'block',
                            scrollback: 1000,
                            copyShortcut: 'ctrl-c',
                            pasteShortcut: 'ctrl-v'
                        },
                        general: {
                            language: 'zh-CN',
                            theme: 'dark',
                            zoom: 1,
                            autoSaveSessions: true,
                            reconnectOnStart: false,
                            connectionTimeout: 30,
                            enableNotifications: true,
                            soundEnabled: true
                        },
                        security: {
                            encryptPasswords: false,
                            sessionTimeout: 30,
                            confirmDangerousCommands: true
                        }
                    };

                    // 统一使用 aiChat 格式，不兼容旧的 ai 格式
                    const processedSettings = {
                        ...defaultSettings,
                        aiChat: {
                            ...defaultSettings.aiChat,
                            ...(savedSettings.aiChat || {}),
                            // 确保必要的字段存在
                            customModel: savedSettings.aiChat?.customModel || '',
                            systemPromptEnabled: savedSettings.aiChat?.systemPromptEnabled ?? false,
                            systemPrompt: savedSettings.aiChat?.systemPrompt || defaultSettings.aiChat.systemPrompt,
                            saveHistory: savedSettings.aiChat?.saveHistory ?? true,
                            historyRetentionDays: savedSettings.aiChat?.historyRetentionDays || 30
                        },
                        aiCompletion: {
                            ...defaultSettings.aiCompletion,
                            ...(savedSettings.aiCompletion || {}),
                            customModel: savedSettings.aiCompletion?.customModel || savedSettings.aiCompletion?.model || ''
                        },
                        terminal: {
                            ...defaultSettings.terminal,
                            ...(savedSettings.terminal || {})
                        },
                        general: {
                            ...defaultSettings.general,
                            ...(savedSettings.general || {})
                        },
                        security: {
                            ...defaultSettings.security,
                            ...(savedSettings.security || {})
                        }
                    };

                    // 显示处理后的配置
                    document.getElementById('processedConfig').textContent = JSON.stringify(processedSettings, null, 2);
                    displayConfig(processedSettings, 'loadedConfig');
                    
                    logMessage('配置加载和处理完成', 'success');
                } else {
                    logMessage('未找到配置数据', 'error');
                }
            } catch (error) {
                logMessage(`配置加载失败: ${error.message}`, 'error');
            }
        }

        async function testSaveConfig() {
            logMessage('开始测试配置保存...');
            
            try {
                const testConfig = {
                    aiChat: {
                        provider: 'test-provider',
                        apiKey: 'test-api-key',
                        baseUrl: 'https://test.api.com/v1',
                        model: 'test-model',
                        customModel: 'custom-test-model'
                    },
                    general: {
                        theme: 'light',
                        language: 'en-US'
                    }
                };
                
                const result = await window.electronAPI.saveConfig(testConfig);
                
                if (result.success) {
                    logMessage('配置保存测试成功', 'success');
                } else {
                    logMessage(`配置保存测试失败: ${result.error}`, 'error');
                }
            } catch (error) {
                logMessage(`配置保存测试失败: ${error.message}`, 'error');
            }
        }

        function clearDisplay() {
            document.getElementById('loadedConfig').innerHTML = '<p>点击"测试加载配置"按钮来加载配置</p>';
            document.getElementById('rawConfig').textContent = '暂无数据';
            document.getElementById('processedConfig').textContent = '暂无数据';
            document.getElementById('messages').innerHTML = '';
        }

        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            logMessage('页面加载完成，可以开始测试');
        });
    </script>
</body>
</html>
