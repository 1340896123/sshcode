<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº‹ä»¶è°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #8b5cf6;
            margin-top: 0;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 8px;
        }
        
        .log {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            padding: 12px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 16px;
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #f87171;
        }
        
        .log-entry.success {
            color: #4ade80;
        }
        
        .log-entry.info {
            color: #93c5fd;
        }
        
        .log-entry.warning {
            color: #fbbf24;
        }
        
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        button:hover {
            background: #7c3aed;
        }
        
        button:disabled {
            background: #4a4a4a;
            cursor: not-allowed;
        }
        
        .status {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 16px;
        }
        
        .status-item {
            display: inline-block;
            margin-right: 16px;
            font-size: 12px;
        }
        
        .status-item.success {
            color: #4ade80;
        }
        
        .status-item.error {
            color: #f87171;
        }
        
        .status-item.warning {
            color: #fbbf24;
        }
        
        input[type="text"] {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            width: 300px;
            margin-right: 8px;
        }
        
        .mock-component {
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .mock-component h3 {
            margin-top: 0;
            color: #93c5fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AI äº‹ä»¶è°ƒè¯•æµ‹è¯•</h1>
        
        <div class="status" id="status">
            <div class="status-item">ğŸ“¡ äº‹ä»¶å‘é€: <span id="eventSentCount">0</span></div>
            <div class="status-item">ğŸ‘‚ äº‹ä»¶æ¥æ”¶: <span id="eventReceivedCount">0</span></div>
            <div class="status-item">ğŸ”§ ç›‘å¬å™¨æ•°é‡: <span id="listenerCount">0</span></div>
            <div class="status-item">â± æµ‹è¯•æ—¶é—´: <span id="testTime">0</span>ms</div>
        </div>

        <div class="section">
            <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
            <div>
                <input type="text" id="testCommand" placeholder="è¾“å…¥æµ‹è¯•å‘½ä»¤" value="echo 'Hello World'">
                <input type="text" id="testConnectionId" placeholder="è¿æ¥ID" value="test-connection-1">
                <button onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button onclick="testEventSending()">ğŸ“¡ æµ‹è¯•äº‹ä»¶å‘é€</button>
                <button onclick="testEventListening()">ğŸ‘‚ æµ‹è¯•äº‹ä»¶ç›‘å¬</button>
                <button onclick="simulateAICommand()">ğŸ¤– æ¨¡æ‹ŸAIå‘½ä»¤</button>
                <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
            <div class="log" id="logContainer"></div>
        </div>

        <div class="section">
            <h2>ğŸ§ª æ¨¡æ‹Ÿç»„ä»¶</h2>
            <div class="mock-component" id="mockComponent">
                <h3>CommandExecution ç»„ä»¶æ¨¡æ‹Ÿ</h3>
                <div>çŠ¶æ€: <span id="componentStatus">æœªåˆå§‹åŒ–</span></div>
                <div>å·¥å…·è°ƒç”¨ID: <span id="componentToolCallId">-</span></div>
                <div>å‘½ä»¤: <span id="componentCommand">-</span></div>
                <div>ç»“æœ: <span id="componentResult">-</span></div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo">
                <div>Window å¯¹è±¡: <span id="windowStatus">æ£€æŸ¥ä¸­...</span></div>
                <div>CustomEvent æ”¯æŒ: <span id="customEventStatus">æ£€æŸ¥ä¸­...</span></div>
                <div>addEventListener æ”¯æŒ: <span id="addEventListenerStatus">æ£€æŸ¥ä¸­...</span></div>
                <div>å…¨å±€ç›‘å¬å™¨: <span id="globalListenersStatus">æ£€æŸ¥ä¸­...</span></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let eventSentCount = 0;
        let eventReceivedCount = 0;
        let testStartTime = Date.now();
        let mockComponentState = {
            mounted: false,
            toolCallId: null,
            command: null,
            result: null,
            status: 'idle'
        };

        // æ—¥å¿—ç³»ç»Ÿ
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus() {
            document.getElementById('eventSentCount').textContent = eventSentCount;
            document.getElementById('eventReceivedCount').textContent = eventReceivedCount;
            document.getElementById('listenerCount').textContent = getListenerCount();
            document.getElementById('testTime').textContent = Date.now() - testStartTime;
        }

        // è·å–ç›‘å¬å™¨æ•°é‡
        function getListenerCount() {
            if (!window._aiEventListeners) return 0;
            const startCount = window._aiEventListeners['ai-tool-call-start']?.length || 0;
            const completeCount = window._aiEventListeners['ai-tool-call-complete']?.length || 0;
            return startCount + completeCount;
        }

        // æ¨¡æ‹Ÿ AI å‘½ä»¤æ‰§è¡Œå™¨
        class MockAICommandExecutor {
            constructor() {
                this.pendingCommands = new Map();
                this.commandBuffers = new Map();
            }

            dispatchEvent(eventName, detail) {
                const event = new CustomEvent(eventName, {
                    detail: {
                        ...detail,
                        timestamp: detail.timestamp || Date.now()
                    }
                });
                
                log(`ğŸ“¡ [AI-EVENT] å‡†å¤‡å‘é€äº‹ä»¶: ${eventName}`, 'info');
                log(`äº‹ä»¶è¯¦æƒ…: ${JSON.stringify(detail, null, 2)}`, 'info');

                // æ£€æŸ¥ window å¯¹è±¡
                if (typeof window === 'undefined') {
                    log(`âŒ [AI-EVENT] window å¯¹è±¡ä¸å¯ç”¨`, 'error');
                    return;
                }

                if (typeof window.dispatchEvent !== 'function') {
                    log(`âŒ [AI-EVENT] window.dispatchEvent æ–¹æ³•ä¸å¯ç”¨`, 'error');
                    return;
                }

                try {
                    const listenerCount = getListenerCount();
                    log(`ğŸ” [AI-EVENT] äº‹ä»¶ç›‘å¬å™¨æ•°é‡: ${eventName} -> ${listenerCount}`, 'info');

                    const dispatchResult = window.dispatchEvent(event);
                    eventSentCount++;
                    
                    log(`âœ… [AI-EVENT] äº‹ä»¶å‘é€æˆåŠŸ: ${eventName}`, 'success');
                    log(`dispatchResult: ${dispatchResult}`, 'info');

                    setTimeout(() => {
                        log(`â° [AI-EVENT] äº‹ä»¶å‘é€åæ£€æŸ¥: ${eventName} - 500msåçŠ¶æ€`, 'info');
                        updateStatus();
                    }, 500);

                } catch (error) {
                    log(`âŒ [AI-EVENT] äº‹ä»¶å‘é€å¤±è´¥: ${eventName} - ${error.message}`, 'error');
                }
                
                updateStatus();
            }

            async executeCommand(command, connectionId) {
                const commandId = `ai-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                log(`ğŸ” [AI-DEBUG] å¼€å§‹æ‰§è¡ŒAIå‘½ä»¤: ${command}`, 'info');
                log(`å‘½ä»¤ID: ${commandId}, è¿æ¥ID: ${connectionId}`, 'info');

                this.pendingCommands.set(commandId, {
                    command,
                    connectionId,
                    startTime: Date.now(),
                    output: []
                });

                this.commandBuffers.set(commandId, []);

                // è§¦å‘å¼€å§‹äº‹ä»¶
                this.dispatchEvent('ai-tool-call-start', {
                    command: command,
                    toolCallId: commandId,
                    connectionId: connectionId,
                    timestamp: Date.now()
                });

                // æ¨¡æ‹Ÿå‘½ä»¤æ‰§è¡Œ
                setTimeout(() => {
                    const output = `Command executed: ${command}\nOutput line 1\nOutput line 2\n$ `;
                    this.completeCommand(commandId, output);
                }, 2000);

                return commandId;
            }

            completeCommand(commandId, output) {
                const commandInfo = this.pendingCommands.get(commandId);
                if (!commandInfo) {
                    log(`âš ï¸ [AI-DEBUG] å°è¯•å®Œæˆä¸å­˜åœ¨çš„å‘½ä»¤: ${commandId}`, 'warning');
                    return;
                }

                const executionTime = Date.now() - commandInfo.startTime;
                
                log(`âœ… [AI-DEBUG] å‘½ä»¤æ‰§è¡Œå®Œæˆ: ${commandId}`, 'success');
                log(`æ‰§è¡Œæ—¶é—´: ${executionTime}ms, è¾“å‡ºé•¿åº¦: ${output.length}`, 'info');

                this.pendingCommands.delete(commandId);
                this.commandBuffers.delete(commandId);

                // è§¦å‘å®Œæˆäº‹ä»¶
                this.dispatchEvent('ai-tool-call-complete', {
                    command: commandInfo.command,
                    result: output,
                    toolCallId: commandId,
                    connectionId: commandInfo.connectionId,
                    executionTime: executionTime,
                    outputLength: output.length
                });
            }
        }

        // æ¨¡æ‹Ÿç»„ä»¶
        class MockCommandExecutionComponent {
            constructor() {
                this.message = {
                    type: 'tool-start',
                    metadata: {
                        toolCallId: null,
                        command: null,
                        status: 'idle'
                    }
                };
                this.isMounted = false;
            }

            mount(toolCallId, command) {
                log(`ğŸ” [CommandExecution] ç»„ä»¶æŒ‚è½½å¼€å§‹`, 'info');
                
                this.message.metadata.toolCallId = toolCallId;
                this.message.metadata.command = command;
                this.isMounted = true;

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                window.addEventListener('ai-tool-call-start', this.handleToolCallStart.bind(this));
                window.addEventListener('ai-tool-call-complete', this.handleToolCallComplete.bind(this));

                // æ·»åŠ åˆ°å…¨å±€è·Ÿè¸ª
                if (!window._aiEventListeners) {
                    window._aiEventListeners = {};
                }
                if (!window._aiEventListeners['ai-tool-call-start']) {
                    window._aiEventListeners['ai-tool-call-start'] = [];
                }
                if (!window._aiEventListeners['ai-tool-call-complete']) {
                    window._aiEventListeners['ai-tool-call-complete'] = [];
                }
                
                window._aiEventListeners['ai-tool-call-start'].push({
                    component: 'MockCommandExecution',
                    toolCallId: toolCallId,
                    timestamp: Date.now()
                });
                
                window._aiEventListeners['ai-tool-call-complete'].push({
                    component: 'MockCommandExecution',
                    toolCallId: toolCallId,
                    timestamp: Date.now()
                });

                this.updateComponentDisplay();
                log(`âœ… [CommandExecution] ç»„ä»¶æŒ‚è½½æˆåŠŸ`, 'success');
                updateStatus();
            }

            unmount() {
                log(`ğŸ” [CommandExecution] ç»„ä»¶å¸è½½å¼€å§‹`, 'info');
                
                this.isMounted = false;
                
                window.removeEventListener('ai-tool-call-start', this.handleToolCallStart.bind(this));
                window.removeEventListener('ai-tool-call-complete', this.handleToolCallComplete.bind(this));

                // ä»å…¨å±€è·Ÿè¸ªä¸­ç§»é™¤
                if (window._aiEventListeners) {
                    const toolCallId = this.message.metadata.toolCallId;
                    
                    if (window._aiEventListeners['ai-tool-call-start']) {
                        window._aiEventListeners['ai-tool-call-start'] = window._aiEventListeners['ai-tool-call-start'].filter(
                            listener => !(listener.component === 'MockCommandExecution' && listener.toolCallId === toolCallId)
                        );
                    }
                    
                    if (window._aiEventListeners['ai-tool-call-complete']) {
                        window._aiEventListeners['ai-tool-call-complete'] = window._aiEventListeners['ai-tool-call-complete'].filter(
                            listener => !(listener.component === 'MockCommandExecution' && listener.toolCallId === toolCallId)
                        );
                    }
                }

                this.updateComponentDisplay();
                log(`âœ… [CommandExecution] ç»„ä»¶å¸è½½æˆåŠŸ`, 'success');
                updateStatus();
            }

            handleToolCallStart(event) {
                eventReceivedCount++;
                log(`ğŸ” [CommandExecution] handleToolCallStart è¢«è°ƒç”¨`, 'info');
                
                const { command, toolCallId } = event.detail || {};
                
                log(`ğŸš€ [CommandExecution] æ”¶åˆ°å·¥å…·è°ƒç”¨å¼€å§‹äº‹ä»¶:`, 'info');
                log(`å‘½ä»¤: ${command}, å·¥å…·è°ƒç”¨ID: ${toolCallId}`, 'info');
                log(`å½“å‰æ¶ˆæ¯å·¥å…·è°ƒç”¨ID: ${this.message.metadata.toolCallId}`, 'info');

                if (!event.detail) {
                    log(`âŒ [CommandExecution] äº‹ä»¶è¯¦æƒ…ä¸ºç©º`, 'error');
                    return;
                }

                if (!toolCallId) {
                    log(`âŒ [CommandExecution] toolCallId ä¸ºç©º`, 'error');
                    return;
                }

                if (this.message.metadata.toolCallId === toolCallId) {
                    log(`âœ… [CommandExecution] åŒ¹é…åˆ°å½“å‰æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨å¼€å§‹`, 'success');
                    
                    this.message.metadata.status = 'executing';
                    this.message.metadata.startTime = Date.now();
                    
                    this.updateComponentDisplay();
                    log(`ğŸ”„ [CommandExecution] è§¦å‘å¼€å§‹çŠ¶æ€æ›´æ–°`, 'info');
                } else {
                    log(`âš ï¸ [CommandExecution] å·¥å…·è°ƒç”¨IDä¸åŒ¹é…ï¼Œå¿½ç•¥äº‹ä»¶`, 'warning');
                    log(`æ”¶åˆ°: ${toolCallId}, æœŸæœ›: ${this.message.metadata.toolCallId}`, 'warning');
                }
                
                updateStatus();
            }

            handleToolCallComplete(event) {
                eventReceivedCount++;
                log(`ğŸ” [CommandExecution] handleToolCallComplete è¢«è°ƒç”¨`, 'info');
                
                const { command, result, toolCallId } = event.detail || {};
                
                log(`ğŸ¯ [CommandExecution] æ”¶åˆ°å·¥å…·è°ƒç”¨å®Œæˆäº‹ä»¶:`, 'info');
                log(`å‘½ä»¤: ${command}, å·¥å…·è°ƒç”¨ID: ${toolCallId}`, 'info');
                log(`ç»“æœé•¿åº¦: ${result?.length || 0}`, 'info');
                log(`å½“å‰æ¶ˆæ¯å·¥å…·è°ƒç”¨ID: ${this.message.metadata.toolCallId}`, 'info');

                if (!event.detail) {
                    log(`âŒ [CommandExecution] äº‹ä»¶è¯¦æƒ…ä¸ºç©º`, 'error');
                    return;
                }

                if (!toolCallId) {
                    log(`âŒ [CommandExecution] toolCallId ä¸ºç©º`, 'error');
                    return;
                }

                if (this.message.metadata.toolCallId === toolCallId) {
                    log(`âœ… [CommandExecution] åŒ¹é…åˆ°å½“å‰æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨å®Œæˆ`, 'success');
                    
                    const startTime = this.message.metadata.startTime || Date.now();
                    this.message.metadata.status = 'completed';
                    this.message.metadata.result = result;
                    this.message.metadata.executionTime = Date.now() - startTime;
                    
                    this.updateComponentDisplay();
                    log(`ğŸ”„ [CommandExecution] è§¦å‘å®ŒæˆçŠ¶æ€æ›´æ–°`, 'info');
                } else {
                    log(`âš ï¸ [CommandExecution] å·¥å…·è°ƒç”¨IDä¸åŒ¹é…ï¼Œå¿½ç•¥äº‹ä»¶`, 'warning');
                    log(`æ”¶åˆ°: ${toolCallId}, æœŸæœ›: ${this.message.metadata.toolCallId}`, 'warning');
                }
                
                updateStatus();
            }

            updateComponentDisplay() {
                document.getElementById('componentStatus').textContent = this.message.metadata.status;
                document.getElementById('componentToolCallId').textContent = this.message.metadata.toolCallId || '-';
                document.getElementById('componentCommand').textContent = this.message.metadata.command || '-';
                document.getElementById('componentResult').textContent = this.message.metadata.result ? 
                    this.message.metadata.result.substring(0, 100) + '...' : '-';
            }
        }

        // å…¨å±€å®ä¾‹
        let mockExecutor;
        let mockComponent;

        // åˆå§‹åŒ–
        function init() {
            log('ğŸš€ åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ', 'info');
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            document.getElementById('windowStatus').textContent = typeof window !== 'undefined' ? 'âœ…' : 'âŒ';
            document.getElementById('customEventStatus').textContent = typeof CustomEvent !== 'undefined' ? 'âœ…' : 'âŒ';
            document.getElementById('addEventListenerStatus').textContent = typeof window.addEventListener === 'function' ? 'âœ…' : 'âŒ';
            document.getElementById('globalListenersStatus').textContent = '0';
            
            mockExecutor = new MockAICommandExecutor();
            mockComponent = new MockCommandExecutionComponent();
            
            log('âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ', 'success');
            updateStatus();
        }

        // æµ‹è¯•å‡½æ•°
        function testEventSending() {
            log('ğŸ“¡ å¼€å§‹æµ‹è¯•äº‹ä»¶å‘é€', 'info');
            
            mockExecutor.dispatchEvent('ai-tool-call-start', {
                command: 'echo test',
                toolCallId: 'test-123',
                connectionId: 'test-connection'
            });
            
            setTimeout(() => {
                mockExecutor.dispatchEvent('ai-tool-call-complete', {
                    command: 'echo test',
                    result: 'test output',
                    toolCallId: 'test-123',
                    connectionId: 'test-connection',
                    executionTime: 1000
                });
            }, 1000);
        }

        function testEventListening() {
            log('ğŸ‘‚ å¼€å§‹æµ‹è¯•äº‹ä»¶ç›‘å¬', 'info');
            
            const testToolCallId = 'test-listener-' + Date.now();
            const testCommand = document.getElementById('testCommand').value;
            
            // æŒ‚è½½ç»„ä»¶
            mockComponent.mount(testToolCallId, testCommand);
            
            // å‘é€æµ‹è¯•äº‹ä»¶
            setTimeout(() => {
                mockExecutor.dispatchEvent('ai-tool-call-start', {
                    command: testCommand,
                    toolCallId: testToolCallId,
                    connectionId: 'test-connection'
                });
            }, 500);
            
            setTimeout(() => {
                mockExecutor.dispatchEvent('ai-tool-call-complete', {
                    command: testCommand,
                    result: 'Command completed successfully',
                    toolCallId: testToolCallId,
                    connectionId: 'test-connection',
                    executionTime: 1500
                });
            }, 2000);
        }

        function simulateAICommand() {
            const command = document.getElementById('testCommand').value;
            const connectionId = document.getElementById('testConnectionId').value;
            
            log(`ğŸ¤– æ¨¡æ‹ŸAIå‘½ä»¤æ‰§è¡Œ: ${command}`, 'info');
            
            const commandId = mockExecutor.executeCommand(command, connectionId);
            
            // æŒ‚è½½ç»„ä»¶æ¥ç›‘å¬è¿™ä¸ªå‘½ä»¤
            mockComponent.mount(commandId, command);
        }

        function runFullTest() {
            log('ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹', 'info');
            
            const command = document.getElementById('testCommand').value;
            const connectionId = document.getElementById('testConnectionId').value;
            
            // 1. å¸è½½ç°æœ‰ç»„ä»¶
            if (mockComponent.isMounted) {
                mockComponent.unmount();
            }
            
            // 2. æ‰§è¡Œå‘½ä»¤
            const commandId = mockExecutor.executeCommand(command, connectionId);
            
            // 3. æŒ‚è½½ç»„ä»¶
            mockComponent.mount(commandId, command);
            
            // 4. ç­‰å¾…å®Œæˆ
            setTimeout(() => {
                log('ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ', 'success');
            }, 3000);
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>
