# 对话逻辑管理

<cite>
**Referenced Files in This Document**   
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts)
- [ai.ts](file://src/modules/ai-assistant/stores/ai.ts)
- [aiService.ts](file://src/modules/ai-assistant/utils/aiService.ts)
- [aiCommandExecutor.ts](file://src/modules/ai-assistant/utils/aiCommandExecutor.ts)
- [eventSystem.ts](file://src/utils/eventSystem.ts)
- [aiConstants.ts](file://src/modules/ai-assistant/constants/aiConstants.ts)
- [CommandExecution.vue](file://src/modules/ai-assistant/components/ai/CommandExecution.vue)
- [AIAssistant.vue](file://src/modules/ai-assistant/components/AIAssistant.vue)
- [ai.js](file://src/types/ai.ts)
- [events.ts](file://src/types/events.ts)
- [index.ts](file://src/types/index.ts)
</cite>

## Table of Contents
1. [对话状态管理机制](#对话状态管理机制)
2. [消息发送与AI请求处理](#消息发送与ai请求处理)
3. [事件监听系统](#事件监听系统)
4. [消息管理与展示逻辑](#消息管理与展示逻辑)
5. [工具调用历史管理](#工具调用历史管理)
6. [跨组件状态共享方案](#跨组件状态共享方案)
7. [组件交互流程](#组件交互流程)

## 对话状态管理机制

`useAIChat`组合式函数通过Vue的响应式系统管理对话的核心状态，包括消息历史、用户输入和处理状态等。这些状态使用`ref`函数创建，确保在UI中能够实时响应变化。

```mermaid
classDiagram
class useAIChat {
+messages : Ref<Message[]>
+userInput : Ref<string>
+isProcessing : Ref<boolean>
+isConnected : Ref<boolean>
+toolCallHistory : Ref<ToolCallHistoryItem[]>
+activeToolCall : Ref<ToolCallHistoryItem | null>
+realtimeOutputs : Ref<Map<string, string>>
+sendMessage() : Promise<void>
+addMessage(role, content, actions)
+addSystemMessage(content, type, metadata)
+clearChat()
+getToolCallStats() : ToolCallStats
+retryToolCall(toolCallId)
+clearToolCallHistory()
}
class Message {
+id : string
+role : 'user' | 'assistant' | 'system'
+content : string
+timestamp : Date
+actions? : ParsedResponse['actions']
+type? : string
+metadata? : Record<string, unknown>
}
class ToolCallHistoryItem {
+id : string
+command : string
+connectionId : string
+status : 'executing' | 'completed' | 'error' | 'timeout'
+startTime : number
+endTime? : number
+result? : string
+error? : string
+executionTime : number
}
useAIChat --> Message : "包含"
useAIChat --> ToolCallHistoryItem : "管理"
```

**Diagram sources** 
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L78-L88)
- [ai.js](file://src/types/ai.ts#L98-L108)

**Section sources**
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L78-L115)

## 消息发送与AI请求处理

`sendMessage`方法是对话逻辑的核心，负责构建AI请求、处理流式响应并管理消息ID去重。该方法首先验证用户输入，然后生成唯一的消息ID以防止重复发送，接着调用AI API并处理响应。

```mermaid
sequenceDiagram
participant User as "用户"
participant UI as "UI组件"
participant Composable as "useAIChat"
participant Service as "aiService"
participant API as "AI API"
User->>UI : 输入消息并点击发送
UI->>Composable : 调用sendMessage()
Composable->>Composable : 生成消息ID并检查重复
Composable->>UI : 添加用户消息到界面
Composable->>Composable : 设置isProcessing为true
Composable->>Service : 调用callAIAPI()
Service->>Service : 构建系统提示词和请求数据
Service->>API : 发送API请求
API-->>Service : 返回AI响应
Service-->>Composable : 返回解析后的响应
Composable->>UI : 添加助手消息到界面
Composable->>Composable : 设置isProcessing为false
```

**Diagram sources** 
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [aiService.ts](file://src/modules/ai-assistant/utils/aiService.ts#L311-L328)

**Section sources**
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [aiService.ts](file://src/modules/ai-assistant/utils/aiService.ts#L311-L720)

## 事件监听系统

事件监听系统通过`onEvent`函数实现，监听AI_RESPONSE、AI_COMMAND_START等事件并更新UI状态。系统使用组件ID进行事件管理，确保事件监听器的正确清理。

```mermaid
flowchart TD
A[初始化事件监听器] --> B[监听AI_RESPONSE事件]
A --> C[监听AI_COMMAND_START事件]
A --> D[监听AI_COMMAND_COMPLETE事件]
A --> E[监听AI_COMMAND_ERROR事件]
A --> F[监听AI_CONFIG_REQUIRED事件]
A --> G[监听TERMINAL_OUTPUT事件]
B --> H[处理AI响应]
C --> I[处理命令开始]
D --> J[处理命令完成]
E --> K[处理命令错误]
F --> L[处理配置需求]
G --> M[处理终端输出]
N[组件卸载] --> O[清理所有事件监听器]
```

**Diagram sources** 
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L11-L33)

**Section sources**
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L11-L287)

## 消息管理与展示逻辑

`addMessage`和`addSystemMessage`方法负责维护不同类型消息的展示逻辑。系统消息用于显示工具调用的状态，支持折叠和默认折叠状态。

```mermaid
classDiagram
class MessageManager {
+addMessage(role, content, actions)
+addSystemMessage(content, type, metadata)
+generateMessageId()
}
class MessageType {
+USER : 'user'
+ASSISTANT : 'assistant'
+SYSTEM : 'system'
}
class SystemMessageType {
+tool-start
+tool-complete
+tool-error
+info
}
MessageManager --> MessageType : "使用"
MessageManager --> SystemMessageType : "使用"
Message --> MessageManager : "被管理"
```

**Diagram sources** 
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L78-L88)
- [aiConstants.ts](file://src/modules/ai-assistant/constants/aiConstants.ts#L24-L31)

**Section sources**
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L78-L88)
- [aiConstants.ts](file://src/modules/ai-assistant/constants/aiConstants.ts#L24-L31)

## 工具调用历史管理

工具调用历史通过`toolCallHistory`响应式数组管理，提供统计、重试和清理功能。系统还通过`getToolCallStats`方法提供执行统计信息。

```mermaid
classDiagram
class ToolCallHistory {
+toolCallHistory : Ref<ToolCallHistoryItem[]>
+getToolCallStats() : ToolCallStats
+retryToolCall(toolCallId)
+clearToolCallHistory()
}
class ToolCallStats {
+total : number
+successful : number
+failed : number
+successRate : number
+avgExecutionTime : number
}
ToolCallHistory --> ToolCallHistoryItem : "包含"
ToolCallHistory --> ToolCallStats : "生成"
```

**Diagram sources** 
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L98-L108)
- [ai.js](file://src/types/ai.ts#L141-L149)

**Section sources**
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [ai.js](file://src/types/ai.ts#L98-L149)

## 跨组件状态共享方案

通过Pinia的`useAIStore`状态管理器实现跨组件状态共享，将关键AI配置和对话上下文持久化。store提供计算属性和方法来访问和修改状态。

```mermaid
classDiagram
class useAIStore {
+toolCalls : Map<string, ToolCall>
+activeToolCall : ToolCall | null
+toolCallHistory : ToolCall[]
+configStatus : ConfigStatus
+terminalInput : TerminalInput
+hasActiveToolCall : ComputedRef<boolean>
+getToolCallById : ComputedRef<Function>
+getToolCallsByConnectionId : ComputedRef<Function>
+getToolCallStats : ComputedRef<ToolCallStats>
+startToolCall(data)
+completeToolCall(data)
+errorToolCall(data)
+timeoutToolCall(data)
+removeToolCall(id)
+clearToolCalls()
+clearToolCallHistory()
+setConfigRequired(message)
+setConfigured()
+setTerminalInput(text, connectionId)
+showTerminalInput()
+hideTerminalInput()
+clearTerminalInput()
+retryToolCall(id)
+getRealtimeOutput(id)
+updateRealtimeOutput(id, output)
}
class ToolCall {
+id : string
+command : string
+connectionId : string
+status : 'executing' | 'completed' | 'error' | 'timeout'
+startTime : number
+endTime? : number
+result? : string
+error? : string
+executionTime : number
+realtimeOutput? : string
}
useAIStore --> ToolCall : "管理"
```

**Diagram sources** 
- [ai.ts](file://src/modules/ai-assistant/stores/ai.ts#L18-L271)
- [ai.js](file://src/types/ai.ts#L116-L149)

**Section sources**
- [ai.ts](file://src/modules/ai-assistant/stores/ai.ts#L18-L271)
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)

## 组件交互流程

整个对话系统的组件交互流程展示了从用户输入到AI响应的完整过程，包括UI组件、组合式函数、服务层和事件系统的协作。

```mermaid
sequenceDiagram
participant User as "用户"
participant AIAssistant as "AIAssistant.vue"
participant useAIChat as "useAIChat.ts"
participant aiService as "aiService.ts"
participant eventSystem as "eventSystem.ts"
participant CommandExecution as "CommandExecution.vue"
User->>AIAssistant : 输入消息并发送
AIAssistant->>useAIChat : 调用sendMessage()
useAIChat->>useAIChat : 验证输入并添加用户消息
useAIChat->>aiService : 调用callAIAPI()
aiService->>aiService : 构建请求并发送到AI API
aiService->>eventSystem : 发送AI_COMMAND_START事件
eventSystem->>useAIChat : 通知命令开始
useAIChat->>useAIChat : 更新工具调用历史
useAIChat->>AIAssistant : 添加系统消息
AIAssistant->>CommandExecution : 渲染执行状态
aiService->>eventSystem : 发送AI_COMMAND_COMPLETE事件
eventSystem->>useAIChat : 通知命令完成
useAIChat->>useAIChat : 更新工具调用状态
useAIChat->>AIAssistant : 更新系统消息
CommandExecution->>CommandExecution : 显示执行结果
aiService-->>useAIChat : 返回AI响应
useAIChat->>AIAssistant : 添加助手消息
AIAssistant->>User : 显示完整对话
```

**Diagram sources** 
- [AIAssistant.vue](file://src/modules/ai-assistant/components/AIAssistant.vue#L1-L695)
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [aiService.ts](file://src/modules/ai-assistant/utils/aiService.ts#L311-L720)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L11-L33)
- [CommandExecution.vue](file://src/modules/ai-assistant/components/ai/CommandExecution.vue#L1-L1063)

**Section sources**
- [AIAssistant.vue](file://src/modules/ai-assistant/components/AIAssistant.vue#L1-L695)
- [useAIChat.ts](file://src/modules/ai-assistant/composables/useAIChat.ts#L24-L615)
- [aiService.ts](file://src/modules/ai-assistant/utils/aiService.ts#L311-L720)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L11-L287)
- [CommandExecution.vue](file://src/modules/ai-assistant/components/ai/CommandExecution.vue#L1-L1063)