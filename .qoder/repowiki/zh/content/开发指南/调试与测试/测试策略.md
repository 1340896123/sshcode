# 测试策略

<cite>
**本文档引用的文件**   
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)
- [vite.config.ts](file://vite.config.ts)
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts)
- [eventSystem.ts](file://src/utils/eventSystem.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件分析](#核心组件分析)
3. [单元测试方案](#单元测试方案)
4. [端到端测试策略](#端到端测试策略)
5. [集成测试建议](#集成测试建议)
6. [测试目录结构](#测试目录结构)
7. [CI集成方案](#ci集成方案)

## 项目结构

```mermaid
graph TD
A[src] --> B[composables]
A --> C[utils]
A --> D[modules]
A --> E[stores]
A --> F[components]
B --> G[useConnectionManager.ts]
C --> H[eventSystem.ts]
D --> I[terminal]
D --> J[file-manager]
D --> K[ai-assistant]
```

**图示来源**
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts)
- [eventSystem.ts](file://src/utils/eventSystem.ts)

**本节来源**
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)
- [vite.config.ts](file://vite.config.ts)

## 核心组件分析

### 连接管理器分析

```mermaid
classDiagram
class useConnectionManager {
+activeConnections : Ref<Connection[]>
+activeTabId : Ref<string | null>
+addConnection(sessionData : SessionData) : Promise<void>
+establishConnection(connection : Connection) : Promise<void>
+disconnectConnection(connectionId : string) : Promise<void>
+closeConnection(connectionId : string) : Promise<void>
+reconnectConnection(connection : Connection) : Promise<void>
+switchTab(connectionId : string) : void
}
useConnectionManager --> useSSHConnectionPool : "使用"
useConnectionManager --> eventSystem : "触发事件"
```

**图示来源**
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)

**本节来源**
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)

### 事件系统分析

```mermaid
classDiagram
class eventSystem {
+EventTypes : Object
+Priority : Object
+SimpleEventManager
+emit(eventType, data, options) : string
+on(eventType, handler, componentId) : Function
+once(eventType, handler, componentId) : void
+off(eventType, handler) : void
+clear() : void
+getHistory(eventType?, limit) : Array
+waitFor(eventType, timeout) : Promise
}
class SimpleEventManager {
-eventHistory : any[]
-maxHistorySize : number
-listeningComponents : Set<string>
+emit(eventType, data, options) : string
+on(eventType, handler, componentId) : Function
+once(eventType, handler, componentId) : void
+off(eventType, handler) : void
+clear() : void
+getHistory(eventType?, limit) : any[]
+getActiveComponents() : string[]
+generateEventId() : string
+waitFor(eventType, timeout) : Promise
+emitBatch(events) : Array
}
eventSystem --> SimpleEventManager : "实例化"
eventSystem : 全局实例 globalEventManager
eventSystem : 导出函数 emitEvent, onEvent, onceEvent, offEvent, waitForEvent, clearAllEvents
```

**图示来源**
- [eventSystem.ts](file://src/utils/eventSystem.ts#L0-L287)

**本节来源**
- [eventSystem.ts](file://src/utils/eventSystem.ts#L0-L287)

## 单元测试方案

为确保代码质量和可维护性，建议采用Vitest作为单元测试框架，针对composables和utils中的纯逻辑函数进行测试。

### useConnectionManager测试

```mermaid
sequenceDiagram
participant Test as "测试用例"
participant CM as "useConnectionManager"
participant Pool as "useSSHConnectionPool"
participant API as "ElectronAPI"
Test->>CM : 初始化连接管理器
CM->>Pool : 调用startCleanupTimer()
Test->>CM : 调用addConnection()
CM->>CM : 创建响应式连接对象
CM->>CM : 设置活动标签页
CM->>CM : 调用establishConnection()
CM->>API : 调用sshConnect()
API-->>CM : 返回连接结果
CM->>CM : 更新连接状态
CM->>CM : 启动监控定时器
CM-->>Test : 返回结果
```

**图示来源**
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)

### eventSystem测试

```mermaid
sequenceDiagram
participant Test as "测试用例"
participant ES as "eventSystem"
Test->>ES : 调用emit()发送事件
ES->>ES : 生成事件ID
ES->>ES : 记录事件历史
ES->>ES : 触发事件监听器
ES-->>Test : 返回事件ID
Test->>ES : 调用on()注册监听器
ES->>ES : 存储组件ID
ES->>ES : 包装处理函数
ES->>ES : 注册到emitter
ES-->>Test : 返回取消监听函数
Test->>ES : 调用once()注册一次性监听器
ES->>ES : 实现一次性监听逻辑
ES-->>Test : 无返回值
Test->>ES : 调用waitFor()等待事件
ES->>ES : 创建Promise
ES->>ES : 设置超时定时器
ES-->>Test : 返回Promise
```

**图示来源**
- [eventSystem.ts](file://src/utils/eventSystem.ts#L0-L287)

**本节来源**
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L0-L287)

## 端到端测试策略

采用Playwright进行端到端测试，覆盖核心用户工作流。

### SSH连接工作流测试

```mermaid
flowchart TD
Start([开始测试]) --> LaunchApp["启动应用"]
LaunchApp --> CreateConnection["创建SSH连接"]
CreateConnection --> FillForm["填写连接表单"]
FillForm --> SaveConnection["保存连接"]
SaveConnection --> Connect["连接到服务器"]
Connect --> VerifyConnection["验证连接状态"]
VerifyConnection --> ExecuteCommand["执行终端命令"]
ExecuteCommand --> VerifyOutput["验证命令输出"]
VerifyOutput --> ManageFiles["文件管理操作"]
ManageFiles --> UploadFile["上传文件"]
UploadFile --> DownloadFile["下载文件"]
DownloadFile --> VerifyFiles["验证文件操作"]
VerifyFiles --> Disconnect["断开连接"]
Disconnect --> CloseApp["关闭应用"]
CloseApp --> End([测试结束])
```

### 文件管理操作测试

```mermaid
flowchart TD
Start([开始测试]) --> Connect["建立SSH连接"]
Connect --> OpenFileManager["打开文件管理器"]
OpenFileManager --> NavigatePath["导航到指定路径"]
NavigatePath --> ListFiles["列出文件"]
ListFiles --> VerifyFiles["验证文件列表"]
VerifyFiles --> UploadFile["上传文件"]
UploadFile --> VerifyUpload["验证上传结果"]
VerifyUpload --> DownloadFile["下载文件"]
DownloadFile --> VerifyDownload["验证下载结果"]
DownloadFile --> DeleteFile["删除文件"]
DeleteFile --> VerifyDeletion["验证删除结果"]
DeleteFile --> End([测试结束])
```

**本节来源**
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)

## 集成测试建议

### IPC通信测试

```mermaid
sequenceDiagram
participant Renderer as "渲染进程"
participant Main as "主进程"
participant SSH as "SSH客户端"
Renderer->>Main : 调用ipcRenderer.invoke('ssh-connect')
Main->>Main : 验证连接配置
Main->>SSH : 创建SSH客户端实例
SSH-->>Main : 触发'ready'事件
Main->>Main : 保存连接到连接池
Main-->>Renderer : 返回连接成功
Renderer->>Main : 调用ipcRenderer.invoke('ssh-execute')
Main->>SSH : 调用exec()执行命令
SSH-->>Main : 返回命令输出
Main-->>Renderer : 返回执行结果
Renderer->>Main : 调用ipcRenderer.invoke('ssh-disconnect')
Main->>SSH : 调用end()关闭连接
Main->>Main : 清理连接池
Main-->>Renderer : 返回断开成功
```

**图示来源**
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)

### Electron API模拟测试

建议使用vitest-electron-tester等工具来模拟Electron API进行隔离测试：

1. 模拟`window.electronAPI`对象
2. 为IPC调用创建模拟实现
3. 测试连接管理器在不同响应下的行为
4. 验证错误处理逻辑

```typescript
// 测试示例结构
describe('useConnectionManager', () => {
  beforeEach(() => {
    // 模拟Electron API
    window.electronAPI = {
      sshConnect: vi.fn(),
      sshExecute: vi.fn(),
      sshDisconnect: vi.fn()
    };
  });
  
  afterEach(() => {
    // 清理模拟
    vi.clearAllMocks();
  });
  
  test('成功建立SSH连接', async () => {
    // 设置模拟返回值
    window.electronAPI.sshConnect.mockResolvedValue({ success: true });
    
    // 执行测试
    await connectionManager.addConnection(testSessionData);
    
    // 验证状态
    expect(connection.status).toBe('connected');
    expect(window.electronAPI.sshConnect).toHaveBeenCalled();
  });
});
```

**本节来源**
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)

## 测试目录结构

建议采用以下测试目录结构：

```mermaid
graph TD
A[tests] --> B[unit]
A --> C[e2e]
A --> D[integration]
A --> E[mocks]
A --> F[fixtures]
B --> G[composables]
B --> H[utils]
B --> I[hooks]
G --> J[useConnectionManager.test.ts]
G --> K[useSSHConnectionPool.test.ts]
H --> L[eventSystem.test.ts]
H --> M[formatters.test.ts]
C --> N[ssh-connection.test.ts]
C --> O[terminal-commands.test.ts]
C --> P[file-management.test.ts]
D --> Q[ipc-communication.test.ts]
D --> R[electron-api.test.ts]
E --> S[electron-api-mock.ts]
E --> T[ssh-client-mock.ts]
F --> U[session-data.json]
F --> V[config.yml]
```

**本节来源**
- [main.ts](file://main.ts)
- [preload.ts](file://preload.ts)
- [useConnectionManager.ts](file://src/composables/useConnectionManager.ts#L10-L538)
- [eventSystem.ts](file://src/utils/eventSystem.ts#L0-L287)

## CI集成方案

```mermaid
flowchart LR
A[代码提交] --> B[CI流水线]
B --> C[安装依赖]
C --> D[单元测试]
D --> E[测试覆盖率检查]
E --> F[端到端测试]
F --> G[集成测试]
G --> H[构建应用]
H --> I[发布制品]
I --> J[部署到测试环境]
D --> |失败| K[停止流水线]
E --> |覆盖率<80%| L[警告]
F --> |失败| K
G --> |失败| K
```

CI流水线应包含以下步骤：

1. **依赖安装**：安装项目依赖和测试工具
2. **单元测试**：运行Vitest测试，确保核心逻辑正确
3. **测试覆盖率**：检查测试覆盖率，建议目标为80%以上
4. **端到端测试**：运行Playwright测试，验证用户工作流
5. **集成测试**：验证IPC通信和Electron API交互
6. **构建应用**：打包Electron应用
7. **发布制品**：将构建产物上传到存储库

**本节来源**
- [vite.config.ts](file://vite.config.ts)
- [package.json](file://package.json)